<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Danh sách Giảng viên</title>
  <link rel="stylesheet" href="../../static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /*Cấu hình chung */
    body { font-family: Arial, sans-serif; }

    /* Form nhập */
    .add-field {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .add-field label {
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }
    .add-field input {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
    }

    /* Upload Excel */
    .upload-area {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .upload-area label {
      font-weight: bold;
      color: #333;
    }
    .upload-area input[type=file] {
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
    }
    .upload-area button {
      background-color: #a44646;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }

    /* Nút thêm */
    .btn-add-gv {
      background-color: #ffffff;
      color: #000000;
      border: 1.5px solid #000;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      align-self: flex-end;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-add-gv:hover {
      background-color: #f2f2f2;
    }

    /* Overlay popup */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }

    .popup-box {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      width: 420px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .popup-box h3 {
      text-align: center;
      color: #c0392b;
      margin-bottom: 15px;
    }
    .popup-buttons {
      text-align: center;
      margin-top: 15px;
    }
    .popup-buttons button {
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      margin: 0 6px;
    }
    .btn-red { background-color: #ff5c5c; }
    .btn-gray { background-color: gray; }
  </style>
</head>

<body>
  <div class="page-container">
    <header class="page-header">
      <div class="header-left">
        <h1>Xin chào, <span id="header">Đang tải...</span></h1>
      </div>
      <div class="header-right">
        Học viện Công nghệ Bưu chính Viễn thông (PTIT - Miền Bắc)
      </div>
    </header>

    <div class="page-body">
      <aside class="sidebar-nav">
        <ul>
          <li><a href="trangChu.html">Trang chủ</a></li>
          <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
          <li><a href="danhsachkhoa.html">Danh sách Khoa</a></li>
          <li class="active"><a href="danhsachgv.html">Danh sách giảng viên từng khoa</a></li>
          <li><a href="danhsachsv.html">Danh sách sinh viên từng khoa</a></li>
          <li><a href="../index.html#logout">Đăng Xuất</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <!-- Thanh chức năng -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
          <div style="flex:1; min-width:200px;">
            <select id="departmentSelect" style="padding:6px; border-radius:8px; width:80%;">
              <option value="">--Chọn khoa--</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="upload-area">
              <label for="excelFile">Tải lên GV từ Excel:</label>
              <input type="file" id="excelFile" accept=".xlsx,.xls">
              <button id="btnExcel"><i class="fa fa-upload"></i> Upload danh sách</button>
            </div>
            <button id="btnAddGV" class="btn-add-gv">+ Thêm thủ công</button>
          </div>
        </div>

        <!-- Overlay thêm giảng viên -->
        <div id="addGVOverlay" class="overlay">
          <div class="popup-box">
            <h3>Thêm giảng viên mới</h3>

            <div class="add-field"><label>Mã giảng viên:</label><input id="gv_id" type="text"></div>
            <div class="add-field"><label>Họ và tên:</label><input id="gv_name" type="text"></div>
            <div class="add-field"><label>Email:</label><input id="gv_email" type="email"></div>
            <div class="add-field"><label>Ngày sinh (dd-mm-yyyy):</label><input id="gv_dob" type="text"></div>
            <div class="add-field"><label>Chức vụ:</label><input id="gv_pos" type="text"></div>
            <div class="add-field"><label>Mật khẩu tạm:</label><input id="gv_pass" type="password"></div>

            <div class="popup-buttons">
              <button id="btnSubmitGV" class="btn-red">Thêm giảng viên</button>
              <button id="btnCancelGV" class="btn-gray">Hủy</button>
            </div>
          </div>
        </div>

        <!-- Overlay sửa giảng viên -->
        <div id="editGVOverlay" class="overlay">
          <div class="popup-box">
            <h3>Chỉnh sửa thông tin giảng viên</h3>

            <input type="hidden" id="edit_gv_id">
            <div class="add-field"><label>Họ và tên:</label><input id="edit_gv_name" type="text"></div>
            <div class="add-field"><label>Email:</label><input id="edit_gv_email" type="email"></div>
            <div class="add-field"><label>Ngày sinh (dd-mm-yyyy):</label><input id="edit_gv_dob" type="text"></div>
            <div class="add-field"><label>Chức vụ:</label><input id="edit_gv_pos" type="text"></div>

            <div class="popup-buttons">
              <button id="btnSaveEditGV" class="btn-red">Lưu thay đổi</button>
              <button id="btnCancelEditGV" class="btn-gray">Hủy</button>
            </div>
          </div>
        </div>

        <!-- Bảng danh sách giáo viên -->
        <div class="table-container">
          <table class="danhSach classes-table" style="width:100%; border-collapse:collapse; background-color:white;">
            <thead>
              <tr style="background-color:#ff5c5c; color:white;">
                <th>STT</th>
                <th>Chức vụ</th>
                <th>Mã GV</th>
                <th>Họ và tên</th>
                <th>Email</th>
                <th>Ngày sinh</th>
                <th>Sửa</th>
              </tr>
              <tr>
                <th colspan="2"></th>
                <th><input type="text" id="searchMa" placeholder="<tìm theo mã>" style="width:90%;"></th>
                <th><input type="text" id="searchTen" placeholder="<tìm theo tên>" style="width:90%;"></th>
                <th colspan="3"></th>
              </tr>
            </thead>
            <tbody id="dsGV">
              <tr><td colspan="7" style="text-align:center;">Chọn khoa để xem danh sách giảng viên...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <footer class="page-footer">Phiên bản 1</footer>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";

    //1. Header
    function header() {
      fetch(`${API_BASE}/api/admin/userinfo`, { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          document.getElementById("header").textContent = data["Họ và Tên"] || "Admin";
        })
        .catch(() => document.getElementById("header").textContent = "Không xác định");
    }

    //2. Load danh sách khoa
    function loadDepartments() {
      const select = document.getElementById("departmentSelect");
      fetch(`${API_BASE}/api/admin/list_department`, { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          select.innerHTML = '<option value="">--Chọn khoa--</option>';
          data.forEach(dep => {
            const opt = document.createElement("option");
            opt.value = dep.id;
            opt.textContent = dep["Tên Khoa"];
            select.appendChild(opt);
          });
        })
        .catch(() => alert("Không thể tải danh sách khoa!"));
    }

    //3. Load danh sách giảng viên
    function loadLecturers() {
      const deptId = document.getElementById("departmentSelect").value;
      const tbody = document.getElementById("dsGV");
      if (!deptId) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Vui lòng chọn khoa...</td></tr>';
        return;
      }

      fetch(`${API_BASE}/api/admin/lecturers/${deptId}`, { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          tbody.innerHTML = "";
          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Không có giảng viên nào.</td></tr>';
            return;
          }
          data.forEach((gv, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${gv["Chức vụ"]}</td>
              <td>${gv.id}</td>
              <td>${gv["Họ và Tên"]}</td>
              <td>${gv.email}</td>
              <td>${gv["Ngày Sinh"] || ""}</td>
              <td><button class="btn-edit" data-id="${gv.id}"><i class="fa fa-wrench"></i></button></td>`;
            tbody.appendChild(tr);
          });

          // Bắt sự kiện sửa
          tbody.querySelectorAll(".btn-edit").forEach(btn => {
            btn.addEventListener("click", () => {
              const gv = data.find(g => g.id === btn.dataset.id);
              openEditForm(gv);
            });
          });
        });
    }

    //4. Thêm giảng viên
    function openAddForm() { document.getElementById("addGVOverlay").style.display = "flex"; }
    function cancelAddForm() { document.getElementById("addGVOverlay").style.display = "none"; }

    function submitAddLecturer() {
      const deptId = document.getElementById("departmentSelect").value;
      if (!deptId) return alert("Vui lòng chọn khoa!");

      const id = gv_id.value.trim();
      const fullname = gv_name.value.trim();
      const email = gv_email.value.trim();
      const dob = gv_dob.value.trim();
      const pos = gv_pos.value.trim();
      const pass = gv_pass.value.trim();

      if (!id || !fullname || !email || !dob || !pos || !pass) {
        return alert("Vui lòng nhập đầy đủ thông tin!");
      }

      fetch(`${API_BASE}/api/admin/add_lecturer/${deptId}`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, password: pass, fullname, date_of_birth: dob, email, position: pos })
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Đã thêm giảng viên!");
        document.getElementById("addGVOverlay").style.display = "none";
        loadLecturers();
      })
      .catch(() => alert("Không thể thêm giảng viên!"));
    }

    //5. Sửa giảng viên
    function openEditForm(gv) {
      document.getElementById("edit_gv_id").value = gv.id;
      document.getElementById("edit_gv_name").value = gv["Họ và Tên"];
      document.getElementById("edit_gv_email").value = gv.email;
      document.getElementById("edit_gv_dob").value = gv["Ngày Sinh"] || "";
      document.getElementById("edit_gv_pos").value = gv["Chức vụ"] || "";
      document.getElementById("editGVOverlay").style.display = "flex";
    }
    function cancelEditForm() { document.getElementById("editGVOverlay").style.display = "none"; }

    function saveEditGV() {
      const id = edit_gv_id.value;
      const payload = {
        full_name: edit_gv_name.value,
        email: edit_gv_email.value,
        date_of_birth: edit_gv_dob.value,
        position: edit_gv_pos.value
      };
      if (!confirm("Xác nhận lưu thay đổi?")) return;
      fetch(`${API_BASE}/api/admin/update_lecturer/${id}`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Cập nhật thành công!");
        document.getElementById("editGVOverlay").style.display = "none";
        loadLecturers();
      })
      .catch(() => alert("Không thể cập nhật!"));
    }

    //6. Upload Excel
    function uploadExcel() {
  const deptId = departmentSelect.value;
  if (!deptId) return alert("Vui lòng chọn khoa!");
  const file = excelFile.files[0];
  if (!file) return alert("Chưa chọn file Excel!");

  const formData = new FormData();
  formData.append("file", file);

  fetch(`${API_BASE}/api/admin/upload_excel_lecturer/${deptId}`, {
    method: "POST",
    credentials: "include",
    body: formData
  })
  .then(res => res.json().then(data => ({status: res.status, data})))
  .then(obj => {
    const { status, data } = obj;

    let msg = data.message || "Đã tải file Excel!";
    if (data.added_count) msg += `\nSố GV mới thêm: ${data.added_count}`;
    if (data.skipped_count) msg += `\nSố GV trùng bỏ qua: ${data.skipped_count}`;
    
    alert(msg);

    // Gọi loadLecturers sau 200ms để bảng cập nhật
    setTimeout(() => {
      loadLecturers();
    }, 200);
  })
  .catch(err => alert("Lỗi khi tải file Excel: " + err));
}

    //7. Sự kiện trang 
    document.addEventListener("DOMContentLoaded", () => {
      header();
      loadDepartments();
      departmentSelect.addEventListener("change", loadLecturers);
      btnAddGV.addEventListener("click", openAddForm);
      btnCancelGV.addEventListener("click", cancelAddForm);
      btnSubmitGV.addEventListener("click", submitAddLecturer);
      btnExcel.addEventListener("click", uploadExcel);
      btnCancelEditGV.addEventListener("click", cancelEditForm);
      btnSaveEditGV.addEventListener("click", saveEditGV);
    });
  </script>
</body>
</html>
