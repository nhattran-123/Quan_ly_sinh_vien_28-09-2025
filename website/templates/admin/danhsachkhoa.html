<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Danh sách Khoa</title>
  <link rel="stylesheet" href="../../static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* Thanh chức năng */
    .upload-area {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .upload-area label {
      font-weight: bold;
      color: #333;
    }
    .upload-area input[type=file] {
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
    }
    .upload-area button {
      background-color: #a44646;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }

    /* Nút thêm thủ công */
    .btn-add-item {
      background-color: #fff;
      color: #000;
      border: 1.5px solid #000;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-top: 10px;
    }
    .btn-add-item:hover {
      background-color: #f2f2f2;
    }

    /* Overlay popup */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }

    .popup-box {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      width: 380px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .popup-box h3 {
      text-align: center;
      color: #c0392b;
      margin-bottom: 15px;
    }
    .popup-buttons {
      text-align: center;
      margin-top: 15px;
    }
    .popup-buttons button {
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      margin: 0 6px;
    }
    .btn-red { background-color: #ff5c5c; }
    .btn-gray { background-color: gray; }

    /* Trường nhập */
    .add-field {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .add-field label {
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }
    .add-field input {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="page-container">
    <header class="page-header">
      <div class="header-left">
        <h1>Xin chào, <span id="header">Đang tải...</span></h1>
      </div>
      <div class="header-right">
        Học viện Công nghệ Bưu chính Viễn thông (PTIT - Miền Bắc)
      </div>
    </header>

    <div class="page-body">
      <aside class="sidebar-nav">
        <ul>
          <li><a href="trangChu.html">Trang chủ</a></li>
          <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
          <li class="active"><a href="danhsachkhoa.html">Danh sách Khoa</a></li>
          <li><a href="danhsachgv.html">Danh sách giảng viên từng khoa</a></li>
          <li><a href="danhsachsv.html">Danh sách sinh viên từng khoa</a></li>
          <li><a href="../index.html#logout">Đăng Xuất</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <!-- Thanh chức năng -->
        <div class="upload-area">
          <label for="excelFile">Tải lên từ Excel:</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls">
          <button id="btnExcel"><i class="fa fa-upload"></i> Upload danh sách</button>
        </div>

        <button id="btnAddKhoa" class="btn-add-item">+ Thêm thủ công 1 Khoa</button>

        <!-- Overlay thêm khoa -->
        <div id="addKhoaOverlay" class="overlay">
          <div class="popup-box">
            <h3>Thêm khoa mới</h3>

            <div class="add-field">
              <label for="khoa_id">Mã khoa:</label>
              <input type="text" id="khoa_id" required>
            </div>

            <div class="add-field">
              <label for="khoa_name">Tên khoa:</label>
              <input type="text" id="khoa_name" required>
            </div>

            <div class="popup-buttons">
              <button id="btnSubmitKhoa" class="btn-red">Thêm khoa</button>
              <button id="btnCancelKhoa" class="btn-gray">Hủy</button>
            </div>
          </div>
        </div>

        <!-- Overlay sửa khoa -->
        <div id="editKhoaOverlay" class="overlay">
          <div class="popup-box">
            <h3>Chỉnh sửa khoa</h3>

            <div class="add-field">
              <label for="edit_khoa_id">Mã khoa:</label>
              <input type="text" id="edit_khoa_id" disabled>
            </div>

            <div class="add-field">
              <label for="edit_khoa_name">Tên khoa mới:</label>
              <input type="text" id="edit_khoa_name">
            </div>

            <div class="popup-buttons">
              <button id="btnUpdateKhoa" class="btn-red">Lưu thay đổi</button>
              <button id="btnCancelEdit" class="btn-gray">Hủy</button>
            </div>
          </div>
        </div>

        <!-- Bảng danh sách khoa -->
        <div class="table-container">
          <table class="danhSach classes-table">
            <thead>
              <tr style="background-color:#ff5c5c; color:white;">
                <th>STT</th>
                <th>Tên khoa</th>
                <th>Mã</th>
                <th>Sửa</th>
                <th>Xóa</th>
              </tr>
              <tr>
                <th></th>
                <th><input type="text" id="searchTen" placeholder="&lt;tìm bằng tên&gt;"></th>
                <th><input type="text" id="searchMa" placeholder="&lt;tìm bằng mã&gt;"></th>
                <th colspan="2"></th>
              </tr>
            </thead>
            <tbody id="dsKhoa">
              <tr><td colspan="5" style="text-align:center;">Đang tải dữ liệu...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <footer class="page-footer">Phiên bản 1</footer>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";

    // Header
    function header() {
      fetch(`${API_BASE}/api/admin/userinfo`, { credentials: "include" })
        .then(res => res.json())
        .then(data => document.getElementById("header").textContent = data["Họ và Tên"] || "Admin")
        .catch(() => document.getElementById("header").textContent = "Không xác định");
    }

    // Load danh sách khoa
    function loadDepartments() {
      const tbody = document.getElementById("dsKhoa");
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Đang tải...</td></tr>`;

      fetch(`${API_BASE}/api/admin/list_department`, { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          tbody.innerHTML = "";
          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Không có khoa nào.</td></tr>`;
            return;
          }

          data.forEach((dep, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${dep["Tên Khoa"]}</td>
              <td>${dep.id}</td>
              <td><button class="btn-edit" data-id="${dep.id}" data-name="${dep["Tên Khoa"]}"><i class="fas fa-wrench"></i></button></td>
              <td><button class="btn-delete" data-id="${dep.id}"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(row);
          });
        });
    }

    // Upload Excel
    function uploadExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) return alert("Vui lòng chọn file Excel!");

      const formData = new FormData();
      formData.append("file", file);

      fetch(`${API_BASE}/api/admin/upload-excel-department`, {
        method: "POST",
        credentials: "include",
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Đã xử lý file Excel!");
        loadDepartments();
      })
      .catch(() => alert("Lỗi khi tải file Excel!"));
    }

    // Thêm khoa
    function openAddForm() { document.getElementById("addKhoaOverlay").style.display = "flex"; }
    function closeAddForm() { document.getElementById("addKhoaOverlay").style.display = "none"; }

    function submitAddKhoa() {
      const id = document.getElementById("khoa_id").value.trim();
      const name = document.getElementById("khoa_name").value.trim();
      if (!id || !name) return alert("Vui lòng nhập đầy đủ thông tin!");

      fetch(`${API_BASE}/api/admin/add-department`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, name })
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Thêm khoa thành công!");
        closeAddForm();
        loadDepartments();
      })
      .catch(() => alert("Không thể thêm khoa!"));
    }

    // Sửa khoa (mở popup)
    function openEditForm(id, name) {
      document.getElementById("edit_khoa_id").value = id;
      document.getElementById("edit_khoa_name").value = name;
      document.getElementById("editKhoaOverlay").style.display = "flex";
    }
    function closeEditForm() { document.getElementById("editKhoaOverlay").style.display = "none"; }

    function submitEditKhoa() {
      const id = document.getElementById("edit_khoa_id").value.trim();
      const newName = document.getElementById("edit_khoa_name").value.trim();
      if (!newName) return alert("Tên khoa không được để trống!");

      fetch(`${API_BASE}/api/admin/update-department/${id}`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName })
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Cập nhật thành công!");
        closeEditForm();
        loadDepartments();
      })
      .catch(() => alert("Không thể cập nhật khoa!"));
    }

    // Xóa khoa
    function deleteKhoa(id) {
      if (!confirm(`Bạn có chắc muốn xóa khoa ${id}?`)) return;
      fetch(`${API_BASE}/api/admin/delete-department/${id}`, {
        method: "DELETE",
        credentials: "include"
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || "Đã xóa thành công!");
        loadDepartments();
      })
      .catch(() => alert("Không thể xóa khoa!"));
    }

    // Tìm kiếm
    function searchKhoa() {
      const ten = document.getElementById("searchTen").value.toLowerCase();
      const ma = document.getElementById("searchMa").value.toLowerCase();
      document.querySelectorAll("#dsKhoa tr").forEach(row => {
        const tds = row.querySelectorAll("td");
        if (!tds.length) return;
        const match = tds[1].textContent.toLowerCase().includes(ten) &&
                      tds[2].textContent.toLowerCase().includes(ma);
        row.style.display = match ? "" : "none";
      });
    }

    // Sự kiện
    document.addEventListener("DOMContentLoaded", () => {
      header();
      loadDepartments();

      document.getElementById("btnExcel").addEventListener("click", uploadExcel);
      document.getElementById("btnAddKhoa").addEventListener("click", openAddForm);
      document.getElementById("btnCancelKhoa").addEventListener("click", closeAddForm);
      document.getElementById("btnSubmitKhoa").addEventListener("click", submitAddKhoa);

      document.getElementById("btnCancelEdit").addEventListener("click", closeEditForm);
      document.getElementById("btnUpdateKhoa").addEventListener("click", submitEditKhoa);

      document.getElementById("searchTen").addEventListener("input", searchKhoa);
      document.getElementById("searchMa").addEventListener("input", searchKhoa);

      // Gắn sự kiện sửa/xóa sau khi tải dữ liệu
      document.getElementById("dsKhoa").addEventListener("click", e => {
        const edit = e.target.closest(".btn-edit");
        const del = e.target.closest(".btn-delete");
        if (edit) openEditForm(edit.dataset.id, edit.dataset.name);
        if (del) deleteKhoa(del.dataset.id);
      });
    });
  </script>
</body>
</html>
