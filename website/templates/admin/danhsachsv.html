<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Trang Chủ Admin</title>
    <link rel="stylesheet" href="../../static/style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /*khung chức năng*/
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        /*chọn, up file*/
        .upload-area {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .upload-area label {
            font-weight: bold;
            color: #333;
        }
        .upload-area input[type=file] {
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
        }
        .upload-area button {
            background-color: #a44646;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-add-item {
            background-color: #ffffff;
            color: #000000;
            border: 1.5px solid #000;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            align-self: flex-end;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-add-item:hover {
            background-color: #f2f2f2;
        }
        /* Overlay thêm mới */
        .add-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .add-field label {
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }
        .add-field input, .add-field select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
        }
        /* Sửa thông tin SV*/
        .edit-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .edit-field label {
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }
        .edit-field input, .edit-field select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
        }

    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="header-left">
                <h1>Xin chào, <span id="header">Đang tải...</span></h1>
            </div>
            <div class="header-right">
                Học viện Công nghệ Bưu chính Viễn thông (PTIT- Miền Bắc)
            </div>
        </header>

        <div class="page-body">
            <aside class="sidebar-nav">
                <ul>
                    <li><a href="trangChu.html">Trang chủ</a></li>
                    <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
                    <li><a href="danhsachkhoa.html">Danh sách Khoa</a></li>
                    <li><a href="danhsachgv.html">Danh sách giảng viên từng khoa</a></li>
                    <li class="active"><a href="danhsachsv.html">Danh sách sinh viên từng khoa</a></li>
                    <li><a href="../index.html#logout">Đăng Xuất</a></li>
                </ul>
            </aside>

            <main class="content-area">
                <!-- Thanh chức năng -->
                <div class="toolbar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px;">
                        <select id="departmentSelect" style="padding:6px; border-radius:8px; width:80%;">
                            <option value="">-- Chọn khoa --</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div class="upload-area">
                            <label for="excelFile">Tải lên từ Excel:</label>
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                            <button id="btnExcel"><i class="fa fa-upload"></i> Upload danh sách</button>
                        </div>

                        <button id="btnToggleForm" class="btn-add-item">+ Thêm thủ công</button>
                    </div>
                </div>

                <!-- Overlay thêm thủ công 1 SV (hiện đè lên trang)-->
                <div id="addOverlay" 
                    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                            background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                    <div style="background:#fff; padding:20px 30px; border-radius:10px; width:400px; position:relative;">
                        <h3 style="text-align:center; color:#c0392b; margin-bottom:15px;">Thêm sinh viên mới</h3>

                        <div class="add-field">
                            <label for="newId">Mã sinh viên:</label>
                            <input type="text" id="newId" required>
                        </div>

                        <div class="add-field">
                            <label for="newName">Họ và tên:</label>
                            <input type="text" id="newName" required>
                        </div>

                        <div class="add-field">
                            <label for="newEmail">Email:</label>
                            <input type="email" id="newEmail" required>
                        </div>

                        <div class="add-field">
                            <label for="newDob">Ngày sinh:</label>
                            <input type="text" id="newDob" placeholder="dd-mm-yyyy" required>
                        </div>

                        <div class="add-field">
                            <label for="newYear">Năm nhập học:</label>
                            <input type="text" id="newYear" required>
                        </div>

                        <div class="add-field">
                            <label for="newPass">Mật khẩu:</label>
                            <input type="password" id="newPass" required>
                        </div>

                        <div class="add-field">
                            <label for="sv_status">Trạng thái:</label>
                            <select id="sv_status">
                                <option value="true">Đang học</option>
                                <option value="false">Thôi học</option>
                            </select>
                        </div>

                        <div style="text-align:center; margin-top:15px;">
                            <button id="btnSubmitAdd" style="background:#ff5c5c; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Thêm sinh viên</button>
                            <button id="btnCancelAdd" style="background:gray; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Hủy</button>
                        </div>
                    </div>
                </div>

                <!-- Bảng danh sách sinh viên-->
                <div class="table-container"></div>
                    <table class="danhSach classes-table" style="width:100%; border-collapse:collapse; background-color:white;">
                        <thead>
                            <tr style="background-color:#ff5c5c; color:white;">
                                <th>STT</th>
                                <th>Mã SV</th>
                                <th>Họ và tên</th>
                                <th>Email</th>
                                <th>Ngày sinh</th>
                                <th>Khóa/Năm nhập học</th>
                                <th>Trạng thái</th>
                                <th>Sửa</th>
                            </tr>
                            <tr>
                                <th colspan="1"></th>
                                <th><input type="text" id="searchTen" placeholder="&lt;tìm bằng tên&gt;" /></th>
                                <th><input type="text" id="searchMa" placeholder="&lt;tìm bằng mã&gt;" /></th>
                                <th colspan="5"></th>
                            </tr>
                        </thead>
                        <tbody id="dsSV">
                            <tr><td colspan="7" style="text-align:center;">Vui lòng chọn khoa...</td></tr>
                        </tbody>
                    </table>
                </div>
            </main>
            <!-- sửa sinh viên (hiện đè lên trang) -->
            <div id="editOverlay" 
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                        background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                <div style="background:#fff; padding:20px 30px; border-radius:10px; width:400px; position:relative;">
                    <h3 style="text-align:center; color:#c0392b; margin-bottom:15px;">Chỉnh sửa thông tin sinh viên</h3>

                    <div class="edit-field">
                        <label for="editName">Họ và tên:</label>
                        <input type="text" id="editName" required>
                    </div>

                    <div class="edit-field">
                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" required>
                    </div>

                    <div class="edit-field">
                        <label for="editDob">Ngày sinh:</label>
                        <input type="text" id="editDob" placeholder="dd-mm-yyyy" required>
                    </div>

                    <div class="edit-field">
                        <label for="editYear">Năm nhập học:</label>
                        <input type="text" id="editYear" required>
                    </div>

                    <div class="edit-field">
                        <label for="editStatus">Trạng thái:</label>
                        <select id="editStatus">
                            <option value="true">Đang học</option>
                            <option value="false">Thôi học</option>
                        </select>
                    </div>

                    <div style="text-align:center; margin-top:15px;">
                    <button id="btnSaveEdit" style="background:#ff5c5c; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Lưu thay đổi</button>
                    <button id="btnCancelEdit" style="background:gray; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Hủy</button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="page-footer">
            Phiên bản 1
        </footer>
    </div>
    <script>
        const API_BASE = "http://127.0.0.1:5000";

    //1. Hiển thị tên admin ở header
    function header() {
        fetch(`${API_BASE}/api/admin/userinfo`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                console.log("Dữ liệu của Admin được trả về:", data);
                if (!data || data.error) throw new Error("Không thể lấy thông tin người dùng");
                document.getElementById("header").textContent = data["Họ và Tên"];
            })
            .catch(() => {
                document.getElementById("header").textContent = "Không xác định";
            });
    }

    //2. Tải danh sách khoa
    function loadDepartments() {
        fetch(`${API_BASE}/api/admin/list_department`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                console.log("Dữ liệu các khoa được trả về:", data);
                const select = document.getElementById("departmentSelect");
                select.innerHTML = '<option value="">-- Chọn khoa --</option>';
                data.forEach(d => {
                    const opt = document.createElement("option");
                    opt.value = d.id;
                    opt.textContent = d["Tên Khoa"];
                    select.appendChild(opt);
                });
            })
            .catch(() => alert("Không thể tải danh sách khoa."));
    }

    // 3. Tải danh sách sinh viên
    function loadStudents() {
        const deptId = document.getElementById("departmentSelect").value;
        if (!deptId) return;
        fetch(`${API_BASE}/api/admin/students/${deptId}`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                console.log("Dữ liệu các sinh viên đuợc trả về:", data);
                const body = document.getElementById("dsSV");
                body.innerHTML = "";
                if (!Array.isArray(data) || data.length === 0) {
                    body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Không có sinh viên nào.</td></tr>';
                    return;
                }
                data.forEach((st, index) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${st.id}</td>
                        <td>${st["Họ và Tên"]}</td>
                        <td>${st.email}</td>
                        <td>${st["Ngày sinh"] || ""}</td>
                        <td>${st["Khóa học"]}</td>
                        <td>${st["Trạng thái"]}</td>
                        <td>
                            <button class="btn-edit" data-id="${st.id}"><i class="fa fa-wrench"></i></button>
                         </td>
                    `;
                    body.appendChild(tr);
                });
            })
            .catch(err => console.error("Lỗi tải sinh viên:", err));
    }

    //4. Hiện Overlay thêm sinh viên
    function toggleAddForm() {
        const overlay = document.getElementById("addOverlay");
        overlay.style.display = "flex";
    }
    //4.1. Hủy/đóng overlay
    document.getElementById("btnCancelAdd").addEventListener("click", () => {
        document.getElementById("addOverlay").style.display = "none";
    });

    //4.2. Gửi dữ liệu form tới API
    function submitAddStudent() {
        const deptId = document.getElementById("departmentSelect").value;
        if (!deptId) return alert("Vui lòng chọn khoa trước!");

        const id = document.getElementById("newId").value.trim();
        const fullname = document.getElementById("newName").value.trim();
        const email = document.getElementById("newEmail").value.trim();
        const dob = document.getElementById("newDob").value.trim();
        const entryYear = document.getElementById("newYear").value.trim();
        const password = document.getElementById("newPass").value.trim();
        const status = document.getElementById("sv_status").value === "true";

        if (!id || !fullname || !email || !dob || !entryYear || !status || !password) {
            return alert("Vui lòng nhập đầy đủ thông tin!");
        }
        // hàm thêm SV
        fetch(`${API_BASE}/api/admin/add_student/${deptId}`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id, 
                password,       // từ khóa nào giống API thì giữ, ko thì ~định nghĩa lại
                fullname, 
                date_of_birth: dob,
                email, 
                entry_year: entryYear, 
                status          // boolean: true hoặc false (trong models.py)
            })
        })
        .then(res => res.json())
        .then(result => {
            alert(result.message || "Thêm sinh viên thành công!");
            document.getElementById("formAdd").style.display = "none";
            loadStudents();
        })
        .catch(() => alert("Không thể thêm sinh viên!"));
    }

    //5. Sửa thông tin sinh viên
    let currentEditId = null; // giữ id sinh viên đang sửa
    function Edit(id) {
        currentEditId = id;
        const row = document.querySelector(`button[data-id="${id}"]`).closest("tr");
        const tds = row.querySelectorAll("td");

        // Lấy thông tin hiện tại từ bảng
        document.getElementById("editName").value = tds[2].textContent.trim();
        document.getElementById("editEmail").value = tds[3].textContent.trim();
        document.getElementById("editDob").value = tds[4].textContent.trim();
        document.getElementById("editYear").value = tds[5].textContent.trim();
        const statusText = tds[6].textContent.trim();
        document.getElementById("editStatus").value = statusText === "Đang học" ? "true" : "false";

        // Hiện form overlay
        document.getElementById("editOverlay").style.display = "flex";
    }

    //5.1. Sự liện xử lý nút Lưu
    document.getElementById("btnSaveEdit").addEventListener("click", () => {
        if (!currentEditId) return alert("Không xác định sinh viên!");

        const payload = {
            full_name: document.getElementById("editName").value.trim(),
            email: document.getElementById("editEmail").value.trim(),
            date_of_birth: document.getElementById("editDob").value.trim(),
            entry_year: document.getElementById("editYear").value.trim(),
            status: document.getElementById("editStatus").value === "true"
        };

        fetch(`${API_BASE}/api/admin/update_student/${currentEditId}`, {
            method: "PUT",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(result => {
            alert(result.message || "Cập nhật thành công!");
            document.getElementById("editOverlay").style.display = "none";
            loadStudents();
        })
        .catch(() => alert("Lỗi khi cập nhật sinh viên!"));
    });

    //5.2. Sự kiện sử lý nút Hủy
    document.getElementById("btnCancelEdit").addEventListener("click", () => {
        document.getElementById("editOverlay").style.display = "none";
    });


    //6. Thêm nhiều SV bằng file Excel
    function Excel() {
        const deptId = document.getElementById("departmentSelect").value;
        if (!deptId) return alert("Vui lòng chọn khoa!");
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".xlsx,.xls";
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("file", file);
            fetch(`${API_BASE}/api/admin/upload_excel_student/${deptId}`, {
                method: "POST",
                credentials: "include",
                body: formData
            })
            .then(res => res.json())
            .then(result => {
                alert(result.message || "Đã xử lý file Excel!");
                loadStudents();
            })
            .catch(() => alert("Lỗi khi tải file Excel!"));
        };
        input.click();
    }

     //7. Tìm kiếm theo tên / mã
    function Search() {
        const searchTen = document.getElementById("searchTen");
        const searchMa = document.getElementById("searchMa");

        searchTen.addEventListener("input", filterTable);
        searchMa.addEventListener("input", filterTable);

        function filterTable() {
            const ten = searchTen.value.toLowerCase();
            const ma = searchMa.value.toLowerCase();
            const rows = document.querySelectorAll("#dsSV tr");
            rows.forEach(row => {
                const tds = row.querySelectorAll("td");
                if (!tds.length) return;
                const tenSV = tds[1].textContent.toLowerCase().includes(ten);
                const maSV = tds[2].textContent.toLowerCase().includes(ma);
                const match = tenSV && maSV;
                row.style.display = match ? "" : "none";
            });
        }
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        header();
        loadDepartments();

        document.getElementById("departmentSelect").addEventListener("change", loadStudents);
        document.getElementById("btnExcel").addEventListener("click", Excel);

        document.body.addEventListener("click", function(e) {
            const editBtn = e.target.closest(".btn-edit");
            if (editBtn) {
                const id = editBtn.dataset.id;
                Edit(id);
            }
        });
        document.getElementById("btnToggleForm").addEventListener("click", toggleAddForm);
        document.getElementById("btnSubmitAdd").addEventListener("click", submitAddStudent);
        document.getElementById("btnCancelAdd").addEventListener("click", () => {
            document.getElementById("formAdd").style.display = "none";
        });

        Search();
    });
    </script>
</body>
</html>