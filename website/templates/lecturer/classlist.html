<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Các lớp giảng dạy</title>
    <link rel="stylesheet" href="../../static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="header-left">
                <h1>Xin chào, <span id="userNameHeader">Đang tải...</span></h1>
            </div>
            <div class="header-right">
                Học viện Công nghệ Bưu chính Viễn thông (PTIT- Miền Bắc)
            </div>
        </header>

        <div class="page-body">
            <aside class="sidebar-nav">
                <ul>
                    <li><a href="trangChu.html">Trang chủ</a></li>
                    <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
                    <li><a href="edit_info.html">Cập nhật thông tin</a></li>
                    <li class="active"><a href="classlist.html">Các lớp giảng dạy</a></li>
                    <li><a href="../index.html#logout">Đăng Xuất</a></li>
                </ul>
            </aside>

            <main class="content-area">
                <h2 class="content-title">Danh sách lớp giảng dạy</h2>

                <div class="table-container">
                    <table class="danhSach classes-table" id="tblClass">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã lớp</th>
                                <th>Mã Môn</th>
                                <th>Tên khóa học</th>
                                <th>Phòng học</th>
                                <th>Ngày bắt đầu</th>
                                <th>Ngày kết thúc</th>
                                <th>Chức năng</th>
                            </tr>
                        </thead>
                        <tbody id="tblClassBody">
                            <tr><td colspan="8" style="text-align: center;">Đang tải danh sách lớp...</td></tr>
                        </tbody>
                    </table>
                </div>

                <form id="logoutForm" hidden></form>
            </main>
        </div>

        <footer class="page-footer">
            Phiên bản 1
        </footer>
    </div>

    <script src="../../static/form.js"></script>
    <script>
        const API_BASE = "http://127.0.0.1:5000"; // Định nghĩa lại nếu không dùng form.js
        const tblBody = document.getElementById('tblClassBody');
        const userNameHeader = document.getElementById('userNameHeader');

        // Hàm tải tên giảng viên cho header
        function loadLecturerName() {
            fetch(`${API_BASE}/api/auth/current_user`, { method: 'GET', credentials: 'include' })
                .then(response => {
                    if (response.status === 401) { window.location.href = "../index.html"; return Promise.reject('Chưa đăng nhập'); }
                    if (!response.ok) throw new Error('Không thể lấy thông tin người dùng');
                    return response.json();
                })
                .then(data => {
                    if (userNameHeader) userNameHeader.textContent = data["Họ và Tên"] || 'Giảng viên';
                })
                .catch(err => {
                    if (err !== 'Chưa đăng nhập') console.error("Lỗi tải tên người dùng:", err);
                });
        }

        // Hàm tải danh sách lớp
        function loadClassList() {
            fetch(`${API_BASE}/api/lecturer/classSections`, { credentials: 'include' })
            .then(res => {
                if (res.status === 401) { window.location.href = "../index.html"; return Promise.reject('Chưa đăng nhập'); }
                if (!res.ok) throw new Error('Lỗi tải danh sách lớp');
                return res.json();
            })
            .then(classes => {
                tblBody.innerHTML = ''; // Xóa trạng thái đang tải

                // API trả về string nếu không có lớp nào (theo file lecturer.py)
                if (!Array.isArray(classes)) {
                    tblBody.innerHTML = `<tr><td colspan="8" style="text-align: center;">${classes || "Không có lớp giảng dạy nào."}</td></tr>`;
                    return;
                }

                classes.forEach(c => {
                    // Cấu trúc URL cho link xem DS Sinh viên và Quản lý Điểm
                    const studentListLink = `./studentlist.html?class_id=${c.id}`;
                    const gradesLink = `./gradelist.html?class_id=${c.id}`;

                    // Icon Mắt cho DS Sinh viên
                    const studentBtn = `<a href="${studentListLink}" class="view-students-btn" title="Danh sách sinh viên"><i class="fas fa-user-friends"></i></a>`;
                    // Icon Bảng điểm/Đồ thị cho Quản lý Điểm
                    const gradeBtn = `<a href="${gradesLink}" class="view-students-btn" title="Quản lý điểm"><i class="fas fa-chart-bar"></i></a>`;


                    tblBody.innerHTML += `
                        <tr>
                            <td>${c.STT}</td>
                            <td>${c.id}</td>
                            <td>${c.coure_id}</td>
                            <td>${c["Tên khóa học"]}</td>
                            <td>${c["Phòng"]}</td>
                            <td>${c["Ngày bắt đầu"] || "-"}</td>
                            <td>${c["Ngày kết thúc"] || "-"}</td>
                            <td style="text-align: center;">
                                ${studentBtn}
                                ${gradeBtn}
                            </td>
                        </tr>`;
                });
            })
            .catch(err => {
                if (err !== 'Chưa đăng nhập') {
                    console.error("Lỗi tải danh sách lớp:", err);
                    tblBody.innerHTML = `<tr><td colspan="8" style="color: red; text-align: center;">Lỗi: ${err.message}</td></tr>`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadLecturerName();
            loadClassList();
            // Đảm bảo hàm Logout() từ form.js được gọi để xử lý đăng xuất
            Logout(); 
        });
    </script>
</body>
</html>