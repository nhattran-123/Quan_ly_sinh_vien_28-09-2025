<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>C√°c l·ªõp ƒëƒÉng k√Ω</title>
  <link rel="stylesheet" href="../../static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* --- Overlay popup --- */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .overlay.active { display: flex; }
    .popup {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: auto;
      padding: 20px;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .popup header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup h2 { margin: 0; color: #b50000; }
    .close-btn {
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #444;
    }
    .close-btn:hover { color: red; }
    .popup table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    .popup table th, .popup table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .popup table th {
      background-color: #b50000;
      color: white;
    }
    #excel_out {
      margin-top: 10px;
      background-color: #b50000;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    #excel_out:hover { background-color: #a30000; }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <div class="header-left">
        <h1>Xin ch√†o, <span id="userName">ƒêang t·∫£i...</span></h1>
      </div>
      <div class="header-right">
        H·ªçc vi·ªán C√¥ng ngh·ªá B∆∞u ch√≠nh Vi·ªÖn th√¥ng (PTIT - Mi·ªÅn B·∫Øc)
      </div>
    </header>

    <div class="page-body">
      <aside class="sidebar-nav">
        <ul>
          <li><a href="trangChu.html">Trang ch·ªß</a></li>
          <li><a href="../index.html#reset">ƒê·ªïi m·∫≠t kh·∫©u</a></li>
          <li><a href="newInfo.html">C·∫≠p nh·∫≠t th√¥ng tin</a></li>
          <li class="active"><a href="cacLopDangKy.html">C√°c l·ªõp ƒëƒÉng k√Ω</a></li>
          <li><a href="cacMonDangKy.html">C√°c m√¥n ƒëƒÉng k√Ω</a></li>
          <li><a href="../index.html#logout">ƒêƒÉng Xu·∫•t</a></li>
        </ul>
      </aside>

      <main class="content-area">
        <h2 class="content-title">C√°c L·ªõp ƒêƒÉng K√Ω Trong K·ª≥</h2>

        <div class="term-selector">
          <label for="termSelect">Ch·ªçn k·ª≥ h·ªçc:</label>
          <select id="termSelect">
            <option value="">ƒêang t·∫£i k·ª≥ h·ªçc...</option>
          </select>
        </div>

        <div class="table-container">
          <table class="danhSach classes-table">
            <thead>
              <tr>
                <th>M√£ L·ªõp</th>
                <th>M√£ M√¥n</th>
                <th>T√™n M√¥n</th>
                <th>T√™n Gi·∫£ng Vi√™n</th>
                <th>Ph√≤ng H·ªçc</th>
                <th>Ng√†y B·∫Øt ƒê·∫ßu</th>
                <th>Ng√†y K·∫øt Th√∫c</th>
                <th>DS Sinh vi√™n</th>
              </tr>
            </thead>
            <tbody id="classListBody">
              <tr><td colspan="8" style="text-align:center;">Vui l√≤ng ch·ªçn k·ª≥ h·ªçc...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <footer class="page-footer">Phi√™n b·∫£n 1</footer>
  </div>

  <!-- Overlay popup -->
  <div id="studentOverlay" class="overlay">
    <div class="popup">
      <header>
        <h2>Danh s√°ch sinh vi√™n</h2>
        <button class="close-btn" id="closePopup">&times;</button>
      </header>
      <button id="excel_out">üìÑ Xu·∫•t file Excel</button>
      <table>
        <thead>
          <tr>
            <th>STT</th>
            <th>H·ªç t√™n</th>
            <th>M√£ sinh vi√™n</th>
            <th>Email</th>
            <th>Ng√†y sinh</th>
          </tr>
        </thead>
        <tbody id="studentListBody"></tbody>
      </table>
    </div>
  </div>

  <script src="../../static/form.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const termSelect = document.getElementById('termSelect');
      const classListBody = document.getElementById('classListBody');
      const userNameHeader = document.getElementById('userName');
      const overlay = document.getElementById('studentOverlay');
      const closeBtn = document.getElementById('closePopup');
      const studentListBody = document.getElementById('studentListBody');
      const exportBtn = document.getElementById('excel_out');
      let currentClassId = null;
      let currentTermId = null;

      function loadUserName() {
        fetch(`${API_BASE}/api/auth/current_user`, { method: 'GET', credentials: 'include' })
          .then(r => r.json()).then(d => userNameHeader.textContent = d["H·ªç v√† T√™n"] || 'B·∫°n')
          .catch(() => userNameHeader.textContent = "Kh√°ch");
      }

      function loadTerms() {
        fetch(`${API_BASE}/api/student/terms`, { method: 'GET', credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            termSelect.innerHTML = '';
            data.forEach(term => {
              const opt = document.createElement('option');
              opt.value = term["M√£ k·ª≥ h·ªçc"];
              opt.textContent = `${term["T√™n k·ª≥ h·ªçc"]} (${term["Ng√†y b·∫Øt ƒë·∫ßu"]} - ${term["Ng√†y k·∫øt th√∫c"]})`;
              termSelect.appendChild(opt);
            });
            if (data[0]) loadClasses(data[0]["M√£ k·ª≥ h·ªçc"]);
          });
      }

      function loadClasses(termId) {
        currentTermId = termId;
        fetch(`${API_BASE}/api/student/enrollments/${termId}`, { method: 'GET', credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            classListBody.innerHTML = '';
            data.forEach(cls => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${cls["M√£ l·ªõp"]}</td>
                <td>${cls["M√£ M√¥n"]}</td>
                <td>${cls["T√™n M√¥n"]}</td>
                <td>${cls["Gi·∫£ng vi√™n ph·ª• tr√°ch"]}</td>
                <td>${cls["Ph√≤ng h·ªçc"]}</td>
                <td>${cls["Ng√†y b·∫Øt ƒë·∫ßu"]}</td>
                <td>${cls["Ng√†y k·∫øt th√∫c"]}</td>
                <td><button class="view-btn" data-class="${cls["M√£ l·ªõp"]}"><i class="fas fa-eye"></i></button></td>
              `;
              classListBody.appendChild(row);
            });
            document.querySelectorAll('.view-btn').forEach(btn => {
              btn.addEventListener('click', e => {
                const classId = e.currentTarget.dataset.class;
                currentClassId = classId;
                openOverlay(classId);
              });
            });
          });
      }

      function openOverlay(classId) {
        overlay.classList.add('active');
        studentListBody.innerHTML = '<tr><td colspan="5">ƒêang t·∫£i...</td></tr>';
        fetch(`${API_BASE}/api/student/list-student/${classId}/${currentTermId}`, { method: 'GET', credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            studentListBody.innerHTML = '';
            data.forEach(sv => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${sv["STT"]}</td>
                <td>${sv["H·ªç v√† t√™n"]}</td>
                <td>${sv["id"]}</td>
                <td>${sv["email"]}</td>
                <td>${sv["Ng√†y sinh"]}</td>`;
              studentListBody.appendChild(tr);
            });
          });
      }

      exportBtn.addEventListener('click', () => {
        if (currentClassId)
          window.location = `${API_BASE}/api/student/list_student/export-excel/${currentClassId}`;
      });

      closeBtn.addEventListener('click', () => overlay.classList.remove('active'));
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
      });

      termSelect.addEventListener('change', e => loadClasses(e.target.value));

      loadUserName();
      loadTerms();
    });
  </script>
</body>
</html>
