<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Các lớp đăng ký</title>
    <link rel="stylesheet" href="../../static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="header-left">
                <h1>Xin chào, <span id="userName">Đang tải...</span></h1>
            </div>
            <div class="header-right">
                Học viện Công nghệ Bưu chính Viễn thông (PTIT- Miền Bắc)
            </div>
        </header>

        <div class="page-body">
            <aside class="sidebar-nav">
                <ul>
                    <li><a href="trangChu.html">Trang chủ</a></li>
                    <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
                    <li><a href="newInfo.html">Cập nhật thông tin</a></li>
                    <li class="active"><a href="lopTinChi.html">Các lớp đăng ký</a></li>
                    <li><a href="diem.html">Các môn đăng ký</a></li>
                    <li><a href="../index.html#logout">Đăng Xuất</a></li>
                </ul>
            </aside>

            <main class="content-area">
                <h2 class="content-title">Các Lớp Đăng Ký Trong Kỳ</h2>

                <div class="term-selector">
                    <label for="termSelect">Chọn kỳ học:</label>
                    <select id="termSelect">
                        <option value="">Đang tải kỳ học...</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="danhSach classes-table">
                        <thead>
                            <tr>
                                <th>Mã Lớp</th>
                                <th>Mã Môn</th>
                                <th>Tên Môn</th>
                                <th>Tên Giảng Viên</th>
                                <th>Phòng Học</th>
                                <th>Ngày Bắt Đầu</th>
                                <th>Ngày Kết Thúc</th>
                                <th>DS Sinh viên</th>
                            </tr>
                        </thead>
                        <tbody id="classListBody">
                            <tr>
                                <td colspan="8" style="text-align: center;">Vui lòng chọn kỳ học...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <footer class="page-footer">
            Phiên bản 1
        </footer>
    </div>

    <script src="../../static/form.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Chỉ chạy code nếu đúng trang
            if (!window.location.pathname.includes("lopTinChi.html")) return;

            console.log("DOMContentLoaded: Starting script for lopTinChi.html");

            // Lấy elements
            const termSelect = document.getElementById('termSelect');
            const classListBody = document.getElementById('classListBody');
            const userNameHeader = document.getElementById('userName');

            // --- Hàm tải tên người dùng cho header ---
            function loadUserName() {
                fetch(`${API_BASE}/api/auth/current_user`, { method: 'GET', credentials: 'include' })
                    .then(response => {
                        if (response.status === 401) {
                            window.location.href = "../index.html"; // Redirect nếu chưa login
                            return Promise.reject('Chưa đăng nhập');
                        }
                        if (!response.ok) throw new Error('Không thể lấy thông tin người dùng');
                        return response.json();
                    })
                    .then(data => {
                        if (userNameHeader) {
                            userNameHeader.textContent = data["Họ và Tên"] || 'Bạn';
                        }
                    })
                    .catch(err => {
                        if (err !== 'Chưa đăng nhập') {
                            console.error("Lỗi tải tên người dùng:", err);
                            if (userNameHeader) userNameHeader.textContent = "Khách";
                        }
                    });
            }

            // --- Hàm tải danh sách kỳ học ---
            function loadTerms() {
                console.log("Fetching terms...");
                fetch(`${API_BASE}/api/student/terms`, { method: 'GET', credentials: 'include' })
                    .then(res => {
                        if (res.status === 401) { window.location.href = "../index.html"; return Promise.reject('Chưa đăng nhập'); }
                        if (!res.ok) throw new Error('Không thể tải danh sách kỳ học');
                        return res.json();
                    })
                    .then(data => {
                        console.log("Terms received:", data);
                        termSelect.innerHTML = ''; // Xóa option mặc định

                        if (!Array.isArray(data) || data.length === 0) {
                            termSelect.innerHTML = '<option value="">Không có kỳ học nào</option>';
                            classListBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu kỳ học.</td></tr>';
                            return;
                        }

                        // Thêm các kỳ học vào dropdown
                        data.forEach(term => {
                            const opt = document.createElement('option');
                            opt.value = term["Mã kỳ học"];
                            // Hiển thị cả ngày bắt đầu/kết thúc như trong ảnh
                            opt.textContent = `${term["Tên kỳ học"]} (${term["Ngày bắt đầu"]} - ${term["Ngày kết thúc"]})`;
                            termSelect.appendChild(opt);
                        });

                        // Tự động tải danh sách lớp cho kỳ học đầu tiên
                        if (data[0]) {
                            console.log("Loading classes for the first term:", data[0]["Mã kỳ học"]);
                            loadClasses(data[0]["Mã kỳ học"]);
                        }
                    })
                    .catch(err => {
                        if (err !== 'Chưa đăng nhập') {
                            console.error("Lỗi khi tải kỳ học:", err);
                            termSelect.innerHTML = '<option value="">Lỗi tải kỳ học</option>';
                            classListBody.innerHTML = `<tr><td colspan="8" style="text-align: center;">Lỗi: ${err.message}</td></tr>`;
                        }
                    });
            }

            // --- Hàm tải danh sách lớp theo kỳ học ---
            function loadClasses(termId) {
                if (!termId) {
                    classListBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Vui lòng chọn kỳ học hợp lệ.</td></tr>';
                    return;
                }
                console.log(`Fetching classes for term: ${termId}`);
                // Hiển thị trạng thái đang tải
                classListBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Đang tải danh sách lớp...</td></tr>';

                fetch(`${API_BASE}/api/student/enrollments/${termId}`, { method: 'GET', credentials: 'include' })
                    .then(res => {
                        if (res.status === 401) { window.location.href = "../index.html"; return Promise.reject('Chưa đăng nhập'); }
                         // Xử lý trường hợp 404 (Không có lớp) trả về từ API
                         if (res.status === 404) {
                            return res.json().then(errData => {
                                // Ném lỗi để catch xử lý, hoặc trả về mảng rỗng tùy ý
                                throw new Error(errData.message || "Không có lớp nào được đăng ký trong kỳ này.");
                            });
                         }
                        if (!res.ok) throw new Error('Không thể tải danh sách lớp');
                        return res.json();
                    })
                    .then(data => {
                        console.log("Classes received:", data);
                        classListBody.innerHTML = ''; // Xóa nội dung đang tải

                        if (!Array.isArray(data) || data.length === 0) {
                             // Điều này không nên xảy ra nếu API trả 404 đúng cách
                            classListBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có lớp học nào trong kỳ này.</td></tr>';
                            return;
                        }

                        // Hiển thị các lớp trong bảng
                        data.forEach(cls => {
                            const row = document.createElement('tr');

                            // Tạo link xem danh sách sinh viên (mở tab mới)
                            const studentListLink = document.createElement('a');
                            studentListLink.href = `./ds_banHoc.html?class_id=${cls["Mã lớp"]}&term_id=${termId}`;
                            studentListLink.target = "_blank"; // Mở trong tab mới
                            studentListLink.classList.add('view-students-btn'); // Thêm class để CSS
                            studentListLink.innerHTML = '<i class="fas fa-eye"></i>'; // Icon mắt

                            // Tạo nội dung các ô
                            row.innerHTML = `
                                <td>${cls["Mã lớp"] || '-'}</td>
                                <td>${cls["Mã Môn"] || '-'}</td>
                                <td>${cls["Tên Môn"] || '-'}</td>
                                <td>${cls["Giảng viên phụ trách"] || '-'}</td>
                                <td>${cls["Phòng học"] || '-'}</td>
                                <td>${cls["Ngày bắt đầu"] || '-'}</td>
                                <td>${cls["Ngày kết thúc"] || '-'}</td>
                                <td></td> `;
                            // Chèn nút mắt vào ô cuối cùng
                            row.cells[7].appendChild(studentListLink);

                            classListBody.appendChild(row);
                        });
                    })
                    .catch(err => {
                         if (err !== 'Chưa đăng nhập') {
                            console.error("Lỗi khi tải danh sách lớp:", err);
                             // Hiển thị lỗi từ API (ví dụ: "Không có lớp nào được đăng ký")
                            classListBody.innerHTML = `<tr><td colspan="8" style="text-align: center;">${err.message}</td></tr>`;
                         }
                    });
            }

            // --- Gắn sự kiện và gọi hàm khởi tạo ---
            termSelect.addEventListener('change', function () {
                loadClasses(this.value); // Gọi lại khi người dùng chọn kỳ khác
            });

            // Bắt đầu tải dữ liệu
            loadUserName(); // Tải tên cho header
            loadTerms();    // Tải danh sách kỳ học (sẽ tự động gọi loadClasses cho kỳ đầu tiên)

        }); // --- Kết thúc DOMContentLoaded ---
    </script>
</body>
</html>