<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Cập nhật thông tin</title>
  <link rel="stylesheet" href="../../static/style.css">
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <div class="header-left">
        <h1>Xin chào, <span id="userName">Đang tải...</span></h1>
      </div>
      <div class="header-right">
        Học viện Công nghệ Bưu chính Viễn thông (PTIT- Miền Bắc)
      </div>
    </header>

    <div class="page-body">
      <aside class="sidebar-nav">
        <ul>
          <li><a href="trangChu.html">Trang chủ</a></li>
          <li><a href="../index.html#reset">Đổi mật khẩu</a></li>
          <li class="active"><a href="newInfo.html">Cập nhật thông tin</a></li>
          <li><a href="lopTinChi.html">Các lớp đăng ký</a></li>
          <li><a href="diem.html">Các môn đăng ký</a></li>
          <li><a href="../index.html#logout">Đăng Xuất</a></li>
        </ul>
      </aside>

      <main class="content-area update-info-area">
        <div class="info-box shaded form-container">
          <h2 class="content-title form-title">Cập nhật thông tin</h2>
          <form id="setInformationForm">
            <div class="form-group">
              <label for="full_name">Họ và tên:</label>
              <input type="text" id="full_name" value="Đang tải..." />
            </div>
            <div class="form-group">
              <label for="email">Email:</label>
              <input type="email" id="email" value="Đang tải..." required />
            </div>
            <div class="form-group">
              <label for="date_of_birth">Ngày sinh:</label>
              <input type="date" id="date_of_birth" value="" required />
            </div>
            <button type="submit" class="update-button">Thay Đổi</button>
          </form>
        </div>
      </main>
    </div>

    <footer class="page-footer">
      Phiên bản 1
    </footer>
  </div>

  <script src="../../static/form.js"></script>
  <script>
    // Chờ DOM load xong mới chạy code
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOMContentLoaded: Starting script for newInfo.html");

      // --- Chỉ chạy code nếu đúng trang ---
      if (!window.location.pathname.includes("newInfo.html")) {
        console.log("Not on newInfo.html, skipping script.");
        return;
      }

      // --- Lấy các elements cần thiết ---
      const apiUrl = `${API_BASE}/api/student/profile`;
      const form = document.getElementById('setInformationForm');
      const nameInput = document.getElementById("full_name");
      const emailInput = document.getElementById('email');
      const dobInput = document.getElementById('date_of_birth');
      const userNameHeader = document.getElementById('userName');

      // --- Kiểm tra elements ngay lập tức ---
      if (!form || !nameInput || !emailInput || !dobInput || !userNameHeader) {
          console.error("CRITICAL ERROR: One or more required elements not found on DOMContentLoaded!");
          // Hiển thị lỗi rõ ràng hơn cho người dùng
          document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Lỗi tải giao diện. Vui lòng thử làm mới trang hoặc liên hệ hỗ trợ.</h1>';
          return; // Dừng hoàn toàn script
      }
      console.log("All required elements found initially.");

      // --- Hàm chuyển đổi định dạng ngày ---
      function formatDate_DDMMYYYY_to_YYYYMMDD(dateString) {
          if (!dateString || !/^\d{2}-\d{2}-\d{4}$/.test(dateString)) return "";
          const parts = dateString.split('-');
          return `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
      }
      function formatDate_YYYYMMDD_to_DDMMYYYY(dateString) {
          if (!dateString) return "";
          const parts = dateString.split('-');
          return `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-YYYY
      }

      // --- Gọi API GET để điền thông tin ---
      console.log("Fetching profile data...");
      fetch(apiUrl, { method: "GET", credentials: "include" })
        .then(response => {
            console.log("Fetch response status:", response.status);
            if (!response.ok) {
                if (response.status === 401) {
                    console.warn("Unauthorized (401). Redirecting to login.");
                    window.location.href = "../index.html"; // Chuyển về login
                    return Promise.reject('Chưa đăng nhập');
                }
                // Cố gắng parse lỗi JSON nếu có
                return response.json().then(errData => {
                    throw new Error(errData.message || `Lỗi HTTP ${response.status}`);
                }).catch(() => {
                    // Nếu không parse được JSON lỗi
                    throw new Error(`Lỗi HTTP ${response.status} khi tải dữ liệu.`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Profile data received:", data);
            // Điền dữ liệu vào form và header
            const fullName = data["Họ và tên"] || "";
            if (userNameHeader) { // Kiểm tra lại lần nữa cho chắc
                 userNameHeader.textContent = fullName || 'Bạn';
            } else {
                 console.warn("userNameHeader somehow became null after fetch.");
            }
            if(nameInput) nameInput.value = fullName;
            if(emailInput) emailInput.value = data["Email"] || "";
            if(dobInput) dobInput.value = formatDate_DDMMYYYY_to_YYYYMMDD(data["Ngày sinh"]);
            console.log("Form populated.");
        })
        .catch(err => {
            if (err !== 'Chưa đăng nhập') {
                console.error("Error fetching or populating data:", err);
                alert("Không thể tải thông tin sinh viên: " + err.message);
                // Có thể disable form ở đây nếu muốn
                // form.style.opacity = '0.5';
                // form.querySelectorAll('input, button').forEach(el => el.disabled = true);
            }
        });

      // --- Xử lý sự kiện SUBMIT form ---
      form.addEventListener('submit', function (event) {
          event.preventDefault();
          console.log("Form submitted.");

          // Lấy giá trị mới từ form
          const newFullName = nameInput.value.trim();
          const newEmail = emailInput.value.trim();
          const newDobYYYYMMDD = dobInput.value;
          const newDobDDMMYYYY = formatDate_YYYYMMDD_to_DDMMYYYY(newDobYYYYMMDD);

          // Kiểm tra trống
          if (!newFullName || !newEmail || !newDobDDMMYYYY) {
              alert("Vui lòng nhập đầy đủ Họ tên, Email và Ngày sinh.");
              return;
          }

          const updatedInfo = {
            full_name: newFullName,
            email: newEmail,
            date_of_birth: newDobDDMMYYYY
          };
          console.log("Submitting updated info:", updatedInfo);

          // Gọi API PUT
          fetch(apiUrl, {
            method: 'PUT',
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(updatedInfo)
          })
          .then(response => response.json()) // Luôn cố gắng parse JSON
          .then(data => {
            console.log("Update response data:", data);
            if (data.error) {
              alert("Cập nhật thất bại: " + (data.message || data.error));
            } else {
              alert(data.message || "Cập nhật thông tin thành công!");
              // Cập nhật lại header nếu tên thay đổi
              const currentUserNameHeader = document.getElementById('userName'); // Lấy lại tham chiếu
              if (currentUserNameHeader && currentUserNameHeader.textContent !== newFullName) {
                  currentUserNameHeader.textContent = newFullName || 'Bạn';
              }
            }
          })
          .catch(err => {
            console.error("Error submitting update:", err);
            alert("Không thể gửi yêu cầu cập nhật. Lỗi: " + err.message);
          });
      });

    }); // --- Kết thúc DOMContentLoaded ---
  </script>
</body>
</html>